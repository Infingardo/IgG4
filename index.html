<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algoritmo Diagnostico IgG4-RD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .criteria-grid {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }
        
        .criterion {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .criterion.exclusion {
            border-left-color: #f44336;
            background: #fff5f5;
        }
        
        .criterion label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            margin: 0;
        }
        
        .criterion input[type="checkbox"] {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .criterion-text {
            flex: 1;
        }
        
        .criterion-weight {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .criterion-weight.required {
            background: #f44336;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .info-box strong {
            color: #1976d2;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .warning-box strong {
            color: #f57c00;
        }
        
        .exclusion-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .exclusion-box strong {
            color: #c62828;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 25px;
            border-radius: 8px;
            display: none;
        }
        
        .result.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-high {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        
        .result-medium {
            background: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .result-low {
            background: #ffebee;
            border: 2px solid #f44336;
        }
        
        .result h3 {
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .result-high h3 { color: #2e7d32; }
        .result-medium h3 { color: #f57c00; }
        .result-low h3 { color: #c62828; }
        
        .score-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .ihc-section {
            margin-top: 30px;
            padding: 25px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }
        
        .ihc-section.show {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .ratio-result {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        
        .ratio-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .dd-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .dd-list li {
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .dd-list li:before {
            content: "‚ö†Ô∏è";
            position: absolute;
            left: 0;
        }
        
        .hidden {
            display: none;
        }
        
        .disclaimer-box {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
        }
        
        .disclaimer-box strong {
            color: #7b1fa2;
        }
        
        .hpf-note {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Algoritmo Diagnostico IgG4-RD</h1>
            <p>Valutazione istologica per malattia IgG4-correlata</p>
        </div>
        
        <div class="content">
            <!-- STEP 0: Criteri di esclusione -->
            <div class="section">
                <div class="section-title">
                    <span class="step-number">0</span>
                    <span>Criteri di Esclusione (Entry Criteria ACR/EULAR 2019)</span>
                </div>
                
                <div class="exclusion-box">
                    <strong>‚ùå Prima di procedere, conferma l'assenza di:</strong>
                    <div class="criteria-grid" style="margin-top: 15px;">
                        <div class="criterion exclusion">
                            <label>
                                <input type="checkbox" id="excl1">
                                <span class="criterion-text">Neoplasia maligna nota (linfoma, carcinoma, plasmocitoma)</span>
                            </label>
                        </div>
                        <div class="criterion exclusion">
                            <label>
                                <input type="checkbox" id="excl2">
                                <span class="criterion-text">Infezione attiva o recente (TB, funghi, spirochete)</span>
                            </label>
                        </div>
                        <div class="criterion exclusion">
                            <label>
                                <input type="checkbox" id="excl3">
                                <span class="criterion-text">Granulomi ben formati (escludi sarcoidosi, GPA)</span>
                            </label>
                        </div>
                        <div class="criterion exclusion">
                            <label>
                                <input type="checkbox" id="excl4">
                                <span class="criterion-text">Necrosi prominente (escludi infezione, vasculite necrotizzante)</span>
                            </label>
                        </div>
                        <div class="criterion exclusion">
                            <label>
                                <input type="checkbox" id="excl5">
                                <span class="criterion-text">Infiltrato neutrofilico prominente</span>
                            </label>
                        </div>
                        <div class="criterion exclusion">
                            <label>
                                <input type="checkbox" id="excl6">
                                <span class="criterion-text">Clonalit√† B dimostrata (kappa/lambda sbilanciato)</span>
                            </label>
                        </div>
                    </div>
                    <p style="margin-top: 15px; font-size: 13px; color: #c62828;">
                        <strong>‚ö†Ô∏è Se uno o pi√π criteri sono presenti, IgG4-RD √® esclusa o altamente improbabile.</strong>
                    </p>
                </div>
                
                <button class="button" id="proceedBtn" onclick="checkExclusions()" style="margin-top: 20px;">
                    Conferma assenza di criteri di esclusione ‚Üí Procedi
                </button>
            </div>
            
            <!-- STEP 1: Selezione organo (inizialmente nascosto) -->
            <div id="mainSection" class="hidden">
                <div class="section">
                    <div class="section-title">
                        <span class="step-number">1</span>
                        <span>Selezione Organo</span>
                    </div>
                    <label for="organ">Seleziona l'organo biopsiato:</label>
                    <select id="organ">
                        <option value="">-- Seleziona --</option>
                        <option value="pancreas">Pancreas</option>
                        <option value="salivary">Ghiandole salivari (parotide, sottomandibolare)</option>
                        <option value="lymph">Linfonodi</option>
                        <option value="biliary">Vie biliari / colecisti / fegato</option>
                        <option value="kidney">Rene</option>
                        <option value="lung">Polmone</option>
                        <option value="retroperitoneum">Retroperitoneo / mesentere</option>
                        <option value="aorta">Aorta / grossi vasi</option>
                        <option value="orbit">Orbita / ghiandola lacrimale</option>
                        <option value="skin">Cute</option>
                        <option value="meninges">Meningi / pachimeningi</option>
                        <option value="thyroid">Tiroide</option>
                        <option value="prostate">Prostata</option>
                        <option value="other">Altro (generico)</option>
                    </select>
                    <div id="organInfo" class="info-box hidden">
                        <strong>Info organo:</strong>
                        <p id="organInfoText"></p>
                        <p class="hpf-note">* HPF = High Power Field, obiettivo 40√ó, area standard ~0.237 mm¬≤. Contare la media di 3 HPF nelle aree a maggiore densit√†.</p>
                    </div>
                </div>
                
                <div id="criteriaSection" class="section hidden">
                    <div class="section-title">
                        <span class="step-number">2</span>
                        <span>Valutazione Morfologica EE</span>
                    </div>
                    
                    <div class="info-box" style="margin-bottom: 15px;">
                        <strong>üí° Nota:</strong> I criteri sotto sono da valutare su EE. La quantificazione esatta delle plasmacellule IgG4+ richiede IHC (Step 3).
                    </div>
                    
                    <div class="criteria-grid" id="criteriaGrid"></div>
                    
                    <!-- Criterio universale policlonalit√† -->
                    <div class="criterion" style="margin-top: 15px; border-left-color: #4caf50;">
                        <label>
                            <input type="checkbox" id="polyclonal" data-weight="2">
                            <span class="criterion-text">
                                Plasmacellule morfologicamente mature, policlonali (se gi√† testato kappa/lambda)
                                <span class="criterion-weight" style="background: #4caf50;">SUPPORTIVO</span>
                            </span>
                        </label>
                    </div>
                    
                    <div id="ddWarning" class="warning-box">
                        <strong>‚ö†Ô∏è Diagnosi differenziali da escludere:</strong>
                        <ul class="dd-list" id="ddList"></ul>
                    </div>
                    
                    <div class="disclaimer-box">
                        <strong>üìä Nota metodologica:</strong> Lo score utilizzato √® un sistema empirico di supporto decisionale, non un criterio validato. I criteri classificativi ufficiali sono ACR/EULAR 2019, che integrano dati clinici, sierologici, imaging e istologia.
                    </div>
                    
                    <button class="button" onclick="calculateScore()" style="margin-top: 20px;">
                        Calcola Score
                    </button>
                </div>
                
                <div id="resultSection" class="result">
                    <h3 id="resultTitle"></h3>
                    <div class="score-display" id="scoreDisplay"></div>
                    <div id="resultText"></div>
                </div>
                
                <div id="ihcSection" class="ihc-section">
                    <div class="section-title">
                        <span class="step-number">3</span>
                        <span>Interpretazione Immunoistochimica</span>
                    </div>
                    
                    <div class="info-box" style="margin-bottom: 20px;">
                        <strong>üìè Standardizzazione HPF:</strong> Area standard = 0.237 mm¬≤ (obiettivo 40√ó, oculare 10√ó, FN 22). Se il tuo microscopio ha specifiche diverse, considera di applicare un fattore di correzione. Conta la <strong>media di 3 HPF</strong> nelle aree a maggiore densit√† plasmacellulare.
                    </div>
                    
                    <div class="input-group">
                        <label for="igg4Count">N¬∞ cellule IgG4+ per HPF (media di 3 HPF ad alta densit√†):</label>
                        <input type="number" id="igg4Count" min="0" placeholder="es. 85">
                    </div>
                    
                    <div class="input-group">
                        <label for="iggTotal">N¬∞ cellule IgG totali per HPF (se disponibile):</label>
                        <input type="number" id="iggTotal" min="0" placeholder="es. 200">
                    </div>
                    
                    <button class="button" onclick="interpretIHC()">
                        Interpreta IHC
                    </button>
                    
                    <div id="ihcResult" class="ratio-result hidden"></div>
                </div>
            </div>
            
            <div class="section" style="margin-top: 40px;">
                <div class="section-title" style="cursor: pointer;" onclick="toggleBibliography()">
                    <span style="font-size: 20px;">üìö</span>
                    <span>Bibliografia</span>
                    <span id="bibToggle" style="margin-left: auto; font-size: 20px;">‚ñº</span>
                </div>
                
                <div id="bibliographyContent" class="hidden" style="margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">Riferimenti principali</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Wallace ZS, Naden RP, Chari S, et al.</strong><br>
                            The 2019 American College of Rheumatology/European League Against Rheumatism Classification Criteria for IgG4-Related Disease.<br>
                            <em>Arthritis Rheumatol</em> 2020;72(1):7-19.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/31793274/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a> | 
                            <a href="https://doi.org/10.1002/art.41120" target="_blank" style="color: #667eea; text-decoration: none;">üîó DOI</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Deshpande V, Zen Y, Chan JK, et al.</strong><br>
                            Consensus statement on the pathology of IgG4-related disease.<br>
                            <em>Mod Pathol</em> 2012;25(9):1181-1192.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/22596100/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a> | 
                            <a href="https://doi.org/10.1038/modpathol.2012.72" target="_blank" style="color: #667eea; text-decoration: none;">üîó DOI</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Kamisawa T, Zen Y, Pillai S, Stone JH.</strong><br>
                            IgG4-related disease.<br>
                            <em>Lancet</em> 2015;385(9976):1460-1471.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/25481618/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a> | 
                            <a href="https://doi.org/10.1016/S0140-6736(14)60720-0" target="_blank" style="color: #667eea; text-decoration: none;">üîó DOI</a>
                        </div>
                        
                        <h4 style="color: #667eea; margin: 25px 0 15px 0;">Riferimenti organo-specifici</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Pancreas - Shimosegawa T, Chari ST, Frulloni L, et al.</strong><br>
                            International consensus diagnostic criteria for autoimmune pancreatitis.<br>
                            <em>Pancreas</em> 2011;40(3):352-358.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/21412117/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Ghiandole salivari - Geyer JT, Ferry JA, Harris NL, et al.</strong><br>
                            Chronic sclerosing sialadenitis (K√ºttner tumor) is an IgG4-associated disease.<br>
                            <em>Am J Surg Pathol</em> 2010;34(2):202-210.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/20061934/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Rene - Raissian Y, Nasr SH, Larsen CP, et al.</strong><br>
                            Diagnosis of IgG4-related tubulointerstitial nephritis.<br>
                            <em>J Am Soc Nephrol</em> 2011;22(7):1343-1352.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/21719792/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Vie biliari - Nakazawa T, Naitoh I, Hayashi K, et al.</strong><br>
                            Diagnostic criteria for IgG4-related sclerosing cholangitis based on the Japan-Korea expert consensus.<br>
                            <em>J Hepatobiliary Pancreat Sci</em> 2012;19(3):284-292.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/22415652/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Orbita - Sogabe Y, Miyatani K, Goto H, et al.</strong><br>
                            Pathological diagnostic criteria for IgG4-related ophthalmic disease.<br>
                            <em>Jpn J Ophthalmol</em> 2012;56(6):577-578.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/22965620/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Linfonodi - Cheuk W, Chan JK.</strong><br>
                            Lymphadenopathy of IgG4-related disease: an underdiagnosed and overdiagnosed entity.<br>
                            <em>Semin Diagn Pathol</em> 2012;29(4):226-234.<br>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/23068302/" target="_blank" style="color: #667eea; text-decoration: none;">üìé PubMed</a>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #2196f3;">
                            <strong style="color: #1976d2;">üí° Nota</strong><br>
                            <span style="font-size: 14px;">I criteri diagnostici ACR/EULAR 2019 rappresentano lo standard attuale per la classificazione della IgG4-RD. La diagnosi definitiva richiede sempre correlazione clinico-patologica multidisciplinare. Lo score morfologico utilizzato in questo strumento √® un supporto empirico, non un criterio validato.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const organData = {
            pancreas: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Fibrosi storiforme e flebite obliterante sono caratteristiche tipiche.",
                dd: [
                    "Pancreatite autoimmune tipo 2 (IgG4-, GEL+, et√† giovane)",
                    "Adenocarcinoma desmoplastico (EMA+, CK7+, atipia citologica)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso (valutazione semiquantitativa: abbondante)", weight: 3},
                    {text: "Fibrosi storiforme evidente (pattern a ruota di carro)", weight: 3},
                    {text: "Flebite obliterante presente (occlusione luminale venosa)", weight: 3},
                    {text: "Eosinofili sparsi o in piccoli aggregati", weight: 1},
                    {text: "Aspetto pseudotumorale / massa infiammatoria", weight: 2},
                    {text: "Assenza di atipia epiteliale significativa", weight: 2}
                ]
            },
            salivary: {
                threshold: 100,
                ratio: 40,
                info: "Soglia IgG4+: >100/HPF | Ratio IgG4/IgG: >40% | Atrofia acinare e fibrosi periductale tipiche (Tumore di K√ºttner).",
                dd: [
                    "Sindrome di Sj√∂gren (centri germinativi prominenti, anti-SSA/SSB+)",
                    "Linfoma MALT (CD20+, clonalit√† B, LEL - lymphoepithelial lesions)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso diffuso", weight: 3},
                    {text: "Fibrosi periductale concentrica e atrofia acinare", weight: 3},
                    {text: "Flebite obliterante presente", weight: 2},
                    {text: "Eosinofili sparsi", weight: 1},
                    {text: "Assenza di centri germinativi prominenti/multipli", weight: 2},
                    {text: "Assenza di LEL (lymphoepithelial lesions)", weight: 2}
                ]
            },
            lymph: {
                threshold: 100,
                ratio: 40,
                info: "Soglia IgG4+: >100/HPF | Ratio IgG4/IgG: >40% | Pattern variabili (vedi Cheuk 2012): pi√π comune espansione interfollicolare.",
                dd: [
                    "Malattia di Castleman (pattern 'a bulbo di cipolla' periarteriolare, HHV8+ se MCD)",
                    "Linfoma plasmablastico (CD138+, clonalit√†, MUM1+, Ki67 alto)",
                    "Linfoma di Hodgkin (cellule RS, CD30+, CD15+)"
                ],
                criteria: [
                    {text: "Espansione interfollicolare con plasmacellule mature", weight: 3},
                    {text: "Fibrosi capsulare e/o interfollicolare", weight: 2},
                    {text: "Follicoli reattivi preservati (non pattern Castleman)", weight: 2},
                    {text: "Assenza di pattern 'a bulbo di cipolla' periarteriolare", weight: 2},
                    {text: "Eosinofili presenti nell'infiltrato", weight: 1},
                    {text: "Assenza di cellule atipiche/blastiche", weight: 3}
                ]
            },
            biliary: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Flebite periportale e sclerosi caratteristiche. DD principale: PSC.",
                dd: [
                    "Colangite sclerosante primitiva (fibrosi 'a bulbo di cipolla' periductale, p-ANCA+)",
                    "Colangiocarcinoma (atipia epiteliale, invasione perineurale)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso periportale/periduttale", weight: 3},
                    {text: "Fibrosi storiforme o densa periportale", weight: 3},
                    {text: "Flebite obliterante portale", weight: 3},
                    {text: "Eosinofili nell'infiltrato", weight: 1},
                    {text: "Colangite linfocitica (infiltrato periepiteliale)", weight: 2},
                    {text: "Assenza di atipia epiteliale biliare", weight: 2}
                ]
            },
            kidney: {
                threshold: 10,
                ratio: 40,
                info: "Soglia IgG4+: >10/HPF (ATTENZIONE: soglia molto bassa!) | Ratio IgG4/IgG: >40% | TIN con fibrosi spesso paucicellulare.",
                dd: [
                    "TIN da farmaci (eosinofili prominenti, tubulite acuta, no fibrosi organizzata)",
                    "Pielonefrite xantogranulomatosa (macrofagi schiumosi, necrosi)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare interstiziale (anche modesto)", weight: 3},
                    {text: "Fibrosi interstiziale a pattern storiforme", weight: 3},
                    {text: "Atrofia tubulare", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di tubulite acuta severa", weight: 2},
                    {text: "Assenza di necrosi o granulomi", weight: 2}
                ]
            },
            lung: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Infiltrato perivascolare/peribronchiale. Pattern variabili.",
                dd: [
                    "Granulomatosi con poliangioite (GPA) - granulomi necrotizzanti, vasculite, c-ANCA+",
                    "Polmonite organizzativa (tessuto di granulazione endoluminale, no plasmacitosi)",
                    "Linfoma MALT polmonare (clonalit√† B, LEL)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare perivascolare/peribronchiale denso", weight: 3},
                    {text: "Fibrosi interstiziale o peribronchiale", weight: 2},
                    {text: "Flebite obliterante", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di granulomi necrotizzanti", weight: 3},
                    {text: "Assenza di pattern organizing pneumonia", weight: 2}
                ]
            },
            retroperitoneum: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Masse fibrotiche 'a manicotto' perivascolari.",
                dd: [
                    "Fibrosi retroperitoneale idiopatica (Malattia di Ormond classica, meno plasmacellule)",
                    "Linfoma retroperitoneale",
                    "Liposarcoma ben differenziato / tumore fibroso solitario"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso nello stroma fibroso", weight: 3},
                    {text: "Fibrosi storiforme estesa", weight: 3},
                    {text: "Flebite obliterante", weight: 2},
                    {text: "Coinvolgimento 'a manicotto' di strutture vascolari (aorta, iliache)", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di atipia cellulare o mitosi", weight: 2}
                ]
            },
            aorta: {
                threshold: 30,
                ratio: 40,
                info: "Soglia IgG4+: >30/HPF | Ratio IgG4/IgG: >40% | Infiltrato nell'avventizia, flebite dei vasa vasorum. Correlazione con imaging!",
                dd: [
                    "Aortite di Takayasu (infiltrato transmurale, granulomi, et√† giovane)",
                    "Arterite a cellule giganti (granulomi, cellule giganti, rottura lamina elastica, et√† >50)",
                    "Aortite aterosclerotica (placche, calcificazioni, infiammazione focale)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare avventiziale denso", weight: 3},
                    {text: "Fibrosi avventiziale", weight: 2},
                    {text: "Flebite/arterite dei vasa vasorum", weight: 3},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di infiltrato transmurale/mediale significativo", weight: 2},
                    {text: "Assenza di granulomi o cellule giganti", weight: 3}
                ]
            },
            orbit: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Ghiandola lacrimale con fibrosi sclerosante. Bilateralit√† suggestiva.",
                dd: [
                    "Dacrioadenite cronica aspecifica",
                    "Sarcoidosi orbitaria (granulomi non necrotizzanti)",
                    "Linfoma orbitale MALT (clonalit√† B)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso nella ghiandola lacrimale/tessuti orbitari", weight: 3},
                    {text: "Fibrosi sclerosante", weight: 3},
                    {text: "Flebite obliterante", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di granulomi", weight: 2},
                    {text: "Assenza di LEL", weight: 2}
                ]
            },
            skin: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Raro in forma isolata, pi√π comune in contesto sistemico.",
                dd: [
                    "Pseudolinfoma cutaneo (pattern nodulare, policlonale)",
                    "Linfoma cutaneo B (MALT, marginal zone) - clonalit√†!",
                    "Reazione cutanea da farmaci"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare dermico denso", weight: 3},
                    {text: "Fibrosi dermica", weight: 2},
                    {text: "Flebite superficiale/profonda", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di epidermotropismo", weight: 2},
                    {text: "Pattern non nodulare (esclude pseudolinfoma tipico)", weight: 2}
                ]
            },
            meninges: {
                threshold: 10,
                ratio: 40,
                info: "Soglia IgG4+: >10/HPF (ATTENZIONE: soglia bassa!) | Ratio IgG4/IgG: >40% | Pachimeningite ipertrofica, pu√≤ essere paucicellulare.",
                dd: [
                    "Pachimeningite infettiva (TB, funghi) - colorazioni speciali!",
                    "Pachimeningite da sarcoidosi (granulomi)",
                    "Meningioma fibroso (EMA+, pattern a vortice)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare (anche focale/modesto)", weight: 3},
                    {text: "Fibrosi densa pachimeningea", weight: 3},
                    {text: "Flebite presente", weight: 2},
                    {text: "Ispessimento diffuso delle meningi", weight: 2},
                    {text: "Assenza di granulomi", weight: 3},
                    {text: "Colorazioni speciali per microorganismi negative (PAS, Grocott, ZN)", weight: 3}
                ]
            },
            thyroid: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Variante fibrosante della tiroidite. DD con Riedel (estensione extratiroidea).",
                dd: [
                    "Tiroidite di Hashimoto classica (cellule di H√ºrthle, centri germinativi prominenti)",
                    "Tiroidite di Riedel (fibrosi che estende oltre la capsula, invasione muscoli)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso intratiroideo", weight: 3},
                    {text: "Fibrosi storiforme o densa", weight: 3},
                    {text: "Flebite obliterante", weight: 2},
                    {text: "Atrofia follicolare", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Fibrosi contenuta entro la capsula (DD Riedel)", weight: 2}
                ]
            },
            prostate: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF | Ratio IgG4/IgG: >40% | Raro, pu√≤ mimare carcinoma all'imaging. Spesso diagnosi incidentale.",
                dd: [
                    "Prostatite cronica aspecifica (no fibrosi storiforme)",
                    "Prostatite granulomatosa (granulomi, post-BCG)",
                    "Adenocarcinoma prostatico con reazione stromale (atipia ghiandolare!)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare stromale denso", weight: 3},
                    {text: "Fibrosi stromale storiforme", weight: 2},
                    {text: "Flebite presente", weight: 2},
                    {text: "Eosinofili presenti", weight: 1},
                    {text: "Assenza di granulomi", weight: 2},
                    {text: "Assenza di atipia ghiandolare (AMACR-, p63 conservato)", weight: 3}
                ]
            },
            other: {
                threshold: 50,
                ratio: 40,
                info: "Soglia IgG4+: >50/HPF (riferimento generico) | Ratio IgG4/IgG: >40% | Applicare i criteri morfologici classici di Deshpande 2012.",
                dd: [
                    "Processi infiammatori cronici aspecifici",
                    "Neoplasie con infiltrato infiammatorio ricco (linfomi, carcinomi)"
                ],
                criteria: [
                    {text: "Infiltrato plasmacellulare denso", weight: 3},
                    {text: "Fibrosi storiforme (pattern 'a ruota di carro')", weight: 3},
                    {text: "Flebite obliterante (occlusione venosa da infiltrato)", weight: 3},
                    {text: "Eosinofili presenti nell'infiltrato", weight: 1},
                    {text: "Aspetto pseudotumorale / massa infiammatoria", weight: 2},
                    {text: "Assenza di granulomi, necrosi, atipia franca", weight: 2}
                ]
            }
        };
        
        let selectedOrgan = null;
        let exclusionsChecked = false;
        
        function checkExclusions() {
            const exclusions = ['excl1', 'excl2', 'excl3', 'excl4', 'excl5', 'excl6'];
            const anyChecked = exclusions.some(id => document.getElementById(id).checked);
            
            if (anyChecked) {
                alert('‚ö†Ô∏è Uno o pi√π criteri di esclusione sono presenti.\n\nIgG4-RD √® esclusa o altamente improbabile.\n\nRiconsiderare la diagnosi differenziale.');
                return;
            }
            
            exclusionsChecked = true;
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('proceedBtn').textContent = '‚úì Criteri di esclusione verificati';
            document.getElementById('proceedBtn').disabled = true;
            document.getElementById('mainSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        document.getElementById('organ').addEventListener('change', function() {
            const organ = this.value;
            if (!organ) {
                document.getElementById('organInfo').classList.add('hidden');
                document.getElementById('criteriaSection').classList.add('hidden');
                document.getElementById('resultSection').classList.remove('show');
                document.getElementById('ihcSection').classList.remove('show');
                return;
            }
            
            selectedOrgan = organData[organ];
            
            document.getElementById('organInfoText').textContent = selectedOrgan.info;
            document.getElementById('organInfo').classList.remove('hidden');
            
            const grid = document.getElementById('criteriaGrid');
            grid.innerHTML = '';
            selectedOrgan.criteria.forEach((criterion, index) => {
                const div = document.createElement('div');
                div.className = 'criterion';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" id="criterion${index}" data-weight="${criterion.weight}">
                        <span class="criterion-text">
                            ${criterion.text}
                            <span class="criterion-weight">${'+'.repeat(criterion.weight)}</span>
                        </span>
                    </label>
                `;
                grid.appendChild(div);
            });
            
            // Reset polyclonal checkbox
            document.getElementById('polyclonal').checked = false;
            
            const ddList = document.getElementById('ddList');
            ddList.innerHTML = '';
            selectedOrgan.dd.forEach(dd => {
                const li = document.createElement('li');
                li.textContent = dd;
                ddList.appendChild(li);
            });
            
            document.getElementById('criteriaSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('ihcSection').classList.remove('show');
        });
        
        function calculateScore() {
            if (!selectedOrgan) return;
            
            let score = 0;
            let maxScore = selectedOrgan.criteria.reduce((sum, c) => sum + c.weight, 0);
            
            // Add polyclonal weight to max
            maxScore += 2;
            
            selectedOrgan.criteria.forEach((criterion, index) => {
                const checkbox = document.getElementById(`criterion${index}`);
                if (checkbox && checkbox.checked) {
                    score += criterion.weight;
                }
            });
            
            // Check polyclonal
            if (document.getElementById('polyclonal').checked) {
                score += 2;
            }
            
            const percentage = (score / maxScore * 100).toFixed(0);
            
            const resultSection = document.getElementById('resultSection');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const resultTitle = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');
            
            scoreDisplay.textContent = `${score} / ${maxScore} (${percentage}%)`;
            
            resultSection.classList.remove('result-high', 'result-medium', 'result-low');
            
            if (score >= maxScore * 0.6) {
                resultSection.classList.add('result-high');
                resultTitle.textContent = '‚úÖ IHC IgG4/IgG fortemente indicata';
                resultText.innerHTML = `
                    <strong>Interpretazione:</strong> Il quadro morfologico √® altamente suggestivo per IgG4-RD.<br><br>
                    <strong>Azione:</strong> Procedere con immunoistochimica per IgG4 e IgG totali su sezioni seriali.<br><br>
                    <strong>Nota:</strong> Questo score √® un supporto empirico. La diagnosi definitiva richiede criteri ACR/EULAR 2019 completi (clinica + sierologia + imaging + istologia).
                `;
                document.getElementById('ihcSection').classList.add('show');
            } else if (score >= maxScore * 0.35) {
                resultSection.classList.add('result-medium');
                resultTitle.textContent = '‚ö†Ô∏è IHC consigliata se contesto clinico compatibile';
                resultText.innerHTML = `
                    <strong>Interpretazione:</strong> Il quadro morfologico mostra alcuni elementi compatibili con IgG4-RD, ma non √® tipico.<br><br>
                    <strong>Azione:</strong> 
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Valutare il contesto clinico (imaging, sierologia IgG4, coinvolgimento multi-organo)</li>
                        <li>Se il sospetto clinico √® alto, procedere con IHC</li>
                        <li>Considerare attentamente le diagnosi differenziali elencate</li>
                    </ul>
                `;
                document.getElementById('ihcSection').classList.add('show');
            } else {
                resultSection.classList.add('result-low');
                resultTitle.textContent = '‚ùå IgG4-RD improbabile - Rivalutare diagnosi';
                resultText.innerHTML = `
                    <strong>Interpretazione:</strong> Il quadro morfologico non √® compatibile con IgG4-RD.<br><br>
                    <strong>Azione:</strong> 
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>IHC per IgG4 <strong>non indicata</strong> in assenza di forte sospetto clinico</li>
                        <li>Riconsiderare diagnosi differenziali</li>
                        <li>Valutare altri processi infiammatori cronici, infettivi o neoplastici</li>
                    </ul>
                `;
                document.getElementById('ihcSection').classList.remove('show');
            }
            
            resultSection.classList.add('show');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function interpretIHC() {
            if (!selectedOrgan) return;
            
            const igg4Count = parseFloat(document.getElementById('igg4Count').value);
            const iggTotal = parseFloat(document.getElementById('iggTotal').value);
            
            if (!igg4Count || igg4Count < 0) {
                alert('Inserire un valore valido per IgG4+');
                return;
            }
            
            const resultDiv = document.getElementById('ihcResult');
            
            const meetsThreshold = igg4Count >= selectedOrgan.threshold;
            
            let resultHTML = '<h4>Risultato IHC</h4>';
            resultHTML += `<p><strong>IgG4+ per HPF:</strong> ${igg4Count} (soglia organo-specifica: ‚â•${selectedOrgan.threshold})</p>`;
            
            if (meetsThreshold) {
                resultHTML += `<p style="color: #2e7d32;">‚úÖ IgG4+ ‚â• soglia per questo organo</p>`;
            } else {
                resultHTML += `<p style="color: #f57c00;">‚ö†Ô∏è IgG4+ sotto soglia per questo organo</p>`;
            }
            
            let ratio = null;
            let meetsRatio = false;
            
            if (iggTotal && iggTotal > 0) {
                ratio = (igg4Count / iggTotal * 100).toFixed(1);
                meetsRatio = ratio >= selectedOrgan.ratio;
                
                resultHTML += `<div class="ratio-value">${ratio}%</div>`;
                resultHTML += `<p><strong>Ratio IgG4/IgG:</strong> ${ratio}% (soglia: ‚â•${selectedOrgan.ratio}%)</p>`;
                
                if (meetsRatio) {
                    resultHTML += `<p style="color: #2e7d32;">‚úÖ Ratio ‚â• soglia diagnostica</p>`;
                } else {
                    resultHTML += `<p style="color: #f57c00;">‚ö†Ô∏è Ratio sotto soglia diagnostica</p>`;
                }
            } else {
                resultHTML += `<p style="color: #666; font-style: italic;">Ratio non calcolabile (IgG totali non fornite). <strong>Consigliato eseguire IgG su sezione seriale.</strong></p>`;
            }
            
            if (ratio !== null) {
                if (meetsThreshold && meetsRatio) {
                    resultHTML += `
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                            <strong style="color: #2e7d32;">‚úÖ COMPATIBILE CON IgG4-RD</strong>
                            <p style="margin-top: 10px;">Sia il conteggio IgG4+ che il ratio IgG4/IgG soddisfano i criteri istologici per questo organo.</p>
                            <p style="margin-top: 10px;"><strong>Prossimi passi:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Verificare policlonalit√† (kappa/lambda) se non gi√† fatto</li>
                                <li>Correlare con criteri ACR/EULAR 2019 completi</li>
                                <li>Discussione multidisciplinare con clinici e radiologi</li>
                            </ul>
                        </div>
                    `;
                } else if (meetsThreshold || (ratio >= 30 && ratio < selectedOrgan.ratio)) {
                    resultHTML += `
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ff9800;">
                            <strong style="color: #f57c00;">‚ö†Ô∏è BORDERLINE / SOSPETTO</strong>
                            <p style="margin-top: 10px;">I criteri IHC sono parzialmente soddisfatti. Il quadro potrebbe essere compatibile con IgG4-RD ma richiede stretta correlazione clinico-patologica.</p>
                            <p style="margin-top: 10px;"><strong>Raccomandazioni:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Rivalutare morfologia EE (fibrosi storiforme? flebite obliterante?)</li>
                                <li>Verificare policlonalit√† (kappa/lambda) - escludere plasmocitoma</li>
                                <li>Correlare con sierologia IgG4, imaging, coinvolgimento multi-organo</li>
                                <li>Considerare rebiopsia o biopsia in altra sede se multi-organo</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultHTML += `
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f44336;">
                            <strong style="color: #c62828;">‚ùå NON COMPATIBILE CON IgG4-RD</strong>
                            <p style="margin-top: 10px;">I criteri IHC non sono soddisfatti. Il conteggio IgG4+ e/o il ratio sono insufficienti per la diagnosi.</p>
                            <p style="margin-top: 10px;"><strong>Considerare:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Escludere IgG4-RD come diagnosi primaria</li>
                                <li>Flogosi cronica aspecifica / reattiva</li>
                                <li>Altre diagnosi differenziali organo-specifiche</li>
                                <li>Se forte sospetto clinico persiste, considerare biopsia in altra sede</li>
                            </ul>
                        </div>
                    `;
                }
            } else {
                if (meetsThreshold) {
                    resultHTML += `
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ff9800;">
                            <strong style="color: #f57c00;">‚ö†Ô∏è RISULTATO INCOMPLETO</strong>
                            <p style="margin-top: 10px;">Il conteggio IgG4+ √® ‚â• soglia, ma manca il ratio IgG4/IgG per conferma completa.</p>
                            <p style="margin-top: 10px;"><strong>Azione richiesta:</strong> Eseguire colorazione per IgG totali su sezione seriale per calcolare il ratio. Un alto numero assoluto di IgG4+ senza ratio pu√≤ essere fuorviante (es. plasmocitosi reattiva policlonale intensa).</p>
                        </div>
                    `;
                } else {
                    resultHTML += `
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f44336;">
                            <strong style="color: #c62828;">‚ùå IgG4+ INSUFFICIENTI</strong>
                            <p style="margin-top: 10px;">Il conteggio IgG4+ √® sotto soglia per questo organo (${igg4Count} < ${selectedOrgan.threshold}).</p>
                            <p style="margin-top: 10px;"><strong>Conclusione:</strong> IgG4-RD istologicamente improbabile. Considerare altre diagnosi.</p>
                        </div>
                    `;
                }
            }
            
            resultDiv.innerHTML = resultHTML;
            resultDiv.classList.remove('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function toggleBibliography() {
            const content = document.getElementById('bibliographyContent');
            const toggle = document.getElementById('bibToggle');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
            } else {
                content.classList.add('hidden');
                toggle.textContent = '‚ñº';
            }
        }
    </script>
</body>
</html>
